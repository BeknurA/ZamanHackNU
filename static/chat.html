<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Zaman AI Assistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2D9A86", "accent": "#EEFE6D", "background-light": "#ffffff",
                        "background-dark": "#101922", "text-light": "#101922", "text-dark": "#ffffff",
                        "subtle-light": "#f3f4f6", "subtle-dark": "#1b2837", "border-light": "#e5e7eb",
                        "border-dark": "#374151", "placeholder-light": "#6b7280", "placeholder-dark": "#9ca3af"
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-track { background-color: #f3f4f6; }
        .dark #chat-window::-webkit-scrollbar-thumb { background-color: #4b5563; }
        .dark #chat-window::-webkit-scrollbar-track { background-color: #1f2937; }
        .typing-indicator { display: inline-flex; gap: 4px; align-items: center; }
        .typing-indicator span { width: 8px; height: 8px; background-color: #2D9A86; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }
        .message-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .quick-btn { transition: all 0.2s ease; }
        #mic-button { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; border: 1px solid #ccc; background-color: #f9fafb; }
        .dark #mic-button { background-color: #374151; border-color: #4b5563; }
        #mic-button.recording { background-color: #ef4444; border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239,68,68,0.4); animation: pulse 1.5s infinite; }
        #mic-button.processing { background-color: #eab308; border-color: #eab308; cursor: not-allowed; }
        #mic-icon { fill: #6b7280; transition: fill 0.3s; }
        .dark #mic-icon { fill: #9ca3af; }
        #mic-button.recording #mic-icon { fill: white; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
    </style>
</head>
<body class="bg-subtle-light dark:bg-subtle-dark font-display text-text-light dark:text-text-dark">
    <div class="flex flex-col min-h-screen">
        <header class="flex items-center justify-between px-6 py-3 border-b border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark shadow-sm sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <a href="/" class="hover:opacity-80 transition-opacity"><img src="/static/images/Logo-colors.svg" alt="Zaman Bank Logo" class="h-10"></a>
                <div class="flex flex-col">
                    <span class="text-base font-semibold">Zaman AI Assistant</span>
                    <span class="text-xs text-gray-500 dark:text-gray-400">–í–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥—Ä—É–≥ 24/7</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <div class="w-9 h-9 bg-center bg-no-repeat bg-cover rounded-full border-2 border-primary" style='background-image: url("https://i.pravatar.cc/40?u=aigerim");'></div>
            </div>
        </header>

        <main class="flex-1 flex items-center justify-center p-4 sm:p-6 lg:p-8">
            <section id="chat-interface" class="flex-1 w-full max-w-3xl mx-auto flex flex-col h-full">
                <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900 rounded-t-lg"></div>
                <form id="chat-form" class="p-4 border-t border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark rounded-b-lg">
                    <div class="flex gap-2 mb-3 items-center">
                        <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –Ω–∞–¥–∏–∫—Ç—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 p-3 border border-border-light dark:border-border-dark rounded-lg bg-background-light dark:bg-gray-800 focus:ring-2 focus:ring-primary focus:border-transparent transition-all text-sm" autocomplete="off">
                        <button type="button" id="mic-button" title="–ù–∞—á–∞—Ç—å/–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞" class="flex-shrink-0 bg-subtle-light dark:bg-subtle-dark border-border-light dark:border-border-dark">
                            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
                            </svg>
                        </button>
                        <button type="submit" id="send-button" class="px-5 py-2.5 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <button type="button" id="analyze-button" class="flex-1 px-4 py-2 bg-accent text-primary rounded-lg font-semibold hover:bg-accent/90 transition-colors disabled:opacity-50 text-sm">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É</button>
                        <button type="button" id="goal-button" class="flex-1 px-4 py-2 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg font-semibold hover:bg-purple-200 dark:hover:bg-purple-800 transition-colors disabled:opacity-50 text-sm">üéØ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–ª—å</button>
                    </div>
                    <div id="quick-actions" class="flex flex-wrap gap-2">
                        <button type="button" class="quick-btn px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600" data-message="–ö–∞–∫ –º–Ω–µ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –∫–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö?">üí∞ –°—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –∫–∞—Ñ–µ</button>
                        <button type="button" class="quick-btn px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600" data-message="–ß—Ç–æ —Ç–∞–∫–æ–µ –ú—É—Ä–∞–±–∞—Ö–∞? –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏">üìö –ß—Ç–æ —Ç–∞–∫–æ–µ –ú—É—Ä–∞–±–∞—Ö–∞?</button>
                        <button type="button" class="quick-btn px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600" data-message="–ü–æ—Å–æ–≤–µ—Ç—É–π –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π">üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</button>
                        <button type="button" class="quick-btn px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600" data-message="–ö–∞–∫ –º–Ω–µ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –¥–æ–ª–≥–æ–≤?">üéØ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥–∏</button>
                        <button type="button" class="quick-btn px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors border border-gray-200 dark:border-gray-600" data-message="–°—Ä–∞–≤–Ω–∏ –º–æ–∏ —Ç—Ä–∞—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏">üìä –°—Ä–∞–≤–Ω–∏—Ç—å —Å –¥—Ä—É–≥–∏–º–∏</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const analyzeButton = document.getElementById('analyze-button');
        const goalButton = document.getElementById('goal-button');
        const quickButtons = document.querySelectorAll('.quick-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const micButton = document.getElementById('mic-button');

        const sessionId = 'user_' + Math.random().toString(36).substring(2, 9);
        console.log('üÜî Session ID:', sessionId);
        let isTyping = false, analysisLoaded = false, mediaRecorder, audioChunks = [], isRecording = false, audioStream;

        function setTheme(isDark) {
            if (isDark) { document.documentElement.classList.add('dark'); themeIconLight.classList.add('hidden'); themeIconDark.classList.remove('hidden'); localStorage.setItem('theme', 'dark'); }
            else { document.documentElement.classList.remove('dark'); themeIconLight.classList.remove('hidden'); themeIconDark.classList.add('hidden'); localStorage.setItem('theme', 'light'); }
        }

        function appendMessage(role, content, isHTML = false) {
            const messageElement = document.createElement('div'), isUser = role === 'user', isSystem = role === 'system';
            messageElement.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4 message-enter`;
            let bgClass, icon, iconBg;
            if (isUser) { bgClass = 'bg-primary text-white rounded-tr-none'; icon = 'üë§'; iconBg = 'bg-primary/20'; }
            else if (isSystem) { bgClass = 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300 rounded-lg border-l-4 border-yellow-500 italic'; icon = '‚öôÔ∏è'; iconBg = 'bg-yellow-200 dark:bg-yellow-800'; }
            else { bgClass = 'bg-background-light dark:bg-subtle-dark text-text-light dark:text-text-dark rounded-tl-none border border-border-light dark:border-border-dark'; icon = 'ü§ñ'; iconBg = 'bg-primary/10'; }
            const safeContent = isHTML ? content.replace(/<script.*?>.*?<\/script>/gi, '') : content.replace(/\n/g, '<br>');
            messageElement.innerHTML = `<div class="max-w-xs sm:max-w-md lg:max-w-lg ${bgClass} p-3 rounded-xl shadow-md"><div class="flex items-start gap-2"><div class="flex-shrink-0 w-7 h-7 rounded-full ${iconBg} flex items-center justify-center text-sm mt-0.5">${icon}</div><div class="flex-1 text-sm leading-relaxed">${safeContent}</div></div></div>`;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex justify-start mb-4 message-enter';
            indicator.innerHTML = '<div class="bg-background-light dark:bg-subtle-dark p-3 rounded-xl rounded-tl-none shadow-md border border-border-light dark:border-border-dark"><div class="flex items-center gap-2"><div class="w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center">ü§ñ</div><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>';
            chatWindow.appendChild(indicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function hideTypingIndicator() { const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }

        async function fetchAPI(endpoint, options) {
    console.log(`üîµ –ó–∞–ø—Ä–æ—Å –∫ ${endpoint}:`, options);

    // --- –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ ---
    if (endpoint !== '/api/analyze' && endpoint !== '/api/suggest-goal') {
        isTyping = true; sendButton.disabled = true;
        const isFileUpload = options.body && options.body instanceof FormData;
        if (!isFileUpload) {
            sendButton.textContent = '...';
        }
        showTypingIndicator();
    }
    else if (endpoint === '/api/analyze') { analyzeButton.disabled = true; analyzeButton.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'; }
    else if (endpoint === '/api/suggest-goal') { goalButton.disabled = true; goalButton.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...'; }

    // --- –ö–û–†–†–ï–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ì–û–õ–û–í–ö–û–í ---
    let finalOptions = { ...options };
    if (typeof finalOptions.body === 'string' && finalOptions.method === 'POST') {
        finalOptions.headers = {
            'Content-Type': 'application/json',
            ...(finalOptions.headers || {})
        };
    }
    // --------------------------------

    try {
        console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ fetch –∫ ${endpoint}...`);
        const response = await fetch(endpoint, finalOptions); // –ò—Å–ø–æ–ª—å–∑—É–µ–º finalOptions
        console.log(`üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: ${response.status} ${response.statusText}`);

        // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ finally, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä—ã—Ç–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        // hideTypingIndicator();

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}` }));
            console.error(`‚ùå HTTP –æ—à–∏–±–∫–∞ –æ—Ç ${endpoint}:`, errorData);
            throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        }
        const jsonData = await response.json();
        console.log(`‚úÖ JSON –¥–∞–Ω–Ω—ã–µ –æ—Ç ${endpoint}:`, jsonData);
        return jsonData;
    } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ API ${endpoint}:`, error);
        // hideTypingIndicator(); // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ finally
        appendMessage('assistant', `‚ö†Ô∏è –û—à–∏–±–∫–∞: ${error.message || '–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É.'}`);
        return null;
    }
    finally {
        // –≠–¢–û–¢ –ë–õ–û–ö –ì–ê–†–ê–ù–¢–ò–†–£–ï–¢, —á—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∞ –∫–Ω–æ–ø–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
        isTyping = false;
        sendButton.disabled = false;
        sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        hideTypingIndicator(); // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

        if (endpoint === '/api/analyze' && !analysisLoaded) {
            analyzeButton.disabled = false; analyzeButton.textContent = 'üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É';
        } else if (endpoint === '/api/analyze' && analysisLoaded) {
            analyzeButton.textContent = '‚úì –í—ã–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
        }
        if (endpoint === '/api/suggest-goal') {
            goalButton.disabled = false; goalButton.textContent = 'üéØ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ü–µ–ª—å';
        }
        console.log(`üîö fetchAPI –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è ${endpoint}`);
    }
}

        async function sendMessage(message) {
            if (!message.trim() || isTyping || chatInput.disabled) { console.log('‚ùå sendMessage blocked:', { isEmpty: !message.trim(), isTyping, isDisabled: chatInput.disabled }); return; }
            console.log('‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);
            appendMessage('user', message);
            chatInput.value = '';
            const data = await fetchAPI('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId, message: message }) });
            if (data) { console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç /api/chat:', data); appendMessage('assistant', data.content, true); } else { console.error('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç /api/chat'); }
        }

        async function analyzeTransactions() {
            if (analysisLoaded) return;
            appendMessage('system', 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –≤—ã–ø–∏—Å–∫—É –∏ –∑–∞–≥—Ä—É–∂–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç...');
            const data = await fetchAPI('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
            if (data) { const lines = data.summary.split('\n\n'); const userSummary = lines.length > 1 ? lines[1] : lines[0]; appendMessage('assistant', `‚úÖ –í—ã–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!\n\n${userSummary}\n\n–¢–µ–ø–µ—Ä—å —è –º–æ–≥—É –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã. –û —á–µ–º —Ö–æ—Ç–∏—Ç–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?`, true); analysisLoaded = true; analyzeButton.textContent = '‚úì –í—ã–ø–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'; analyzeButton.disabled = true; goalButton.disabled = false; }
        }

        async function suggestGoal() {
            if (!analysisLoaded) { appendMessage('assistant', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤—ã–ø–∏—Å–∫—É, —á—Ç–æ–±—ã —è –º–æ–≥ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é —Ü–µ–ª—å.'); return; }
            appendMessage('system', 'üéØ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∏ –ø–æ–¥–±–∏—Ä–∞—é –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Ü–µ–ª—å...');
            const data = await fetchAPI('/api/suggest-goal', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ session_id: sessionId }) });
            if (data) { appendMessage('assistant', data.formatted_message, true); }
        }

        async function startRecording() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ.'); }
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.onstop = sendAudioToServer;
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;
                micButton.classList.add('recording');
                micButton.classList.remove('processing');
                appendMessage('system', 'üéôÔ∏è –ì–æ–≤–æ—Ä–∏—Ç–µ... –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.');
                chatInput.placeholder = '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
                chatInput.disabled = true;
            } catch (err) { console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", err); appendMessage('system', `‚ö†Ô∏è ${err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.'}`); resetMicButton(); }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                audioStream?.getTracks().forEach(track => track.stop());
                isRecording = false;
                micButton.classList.remove('recording');
                micButton.classList.add('processing');
                appendMessage('system', 'üé§ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...');
                chatInput.placeholder = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞...';
            }
        }

        async function sendAudioToServer() {
            if (audioChunks.length === 0) { console.warn("–ù–µ—Ç –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏."); resetMicButton(); appendMessage('system', '‚ö†Ô∏è –ó–∞–ø–∏—Å—å –±—ã–ª–∞ –ø—É—Å—Ç–æ–π.'); return; }
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('file', audioBlob, `audio-${sessionId}-${Date.now()}.webm`);
            formData.append('session_id', sessionId);
            const data = await fetchAPI('/api/voice', { method: 'POST', body: formData });
            resetMicButton();
            if (data) { if (data.transcribed_text) { appendMessage('user', `üó£Ô∏è ${data.transcribed_text}`); } if (data.ai_response_text) { appendMessage('assistant', data.ai_response_text, true); } }
        }

        function resetMicButton() { micButton.classList.remove('recording', 'processing'); isRecording = false; audioChunks = []; chatInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –Ω–∞–¥–∏–∫—Ç—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...'; chatInput.disabled = false; }

        themeToggle.addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));
        const savedTheme = localStorage.getItem('theme');
        setTheme(savedTheme === 'dark');

        analyzeButton.addEventListener('click', analyzeTransactions);
        goalButton.addEventListener('click', suggestGoal);
        goalButton.disabled = true;

        quickButtons.forEach(btn => { btn.addEventListener('click', function() { const message = this.getAttribute('data-message'); console.log('‚ö° –ë—ã—Å—Ç—Ä–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞:', message); if (message && !isTyping && !chatInput.disabled) sendMessage(message); }); });
        micButton.addEventListener('click', () => { if (isRecording) stopRecording(); else startRecording(); });
        chatInput.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey && !chatInput.disabled && !isTyping) { e.preventDefault(); const message = chatInput.value.trim(); console.log('‚å®Ô∏è Enter –Ω–∞–∂–∞—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ:', message); if (message) { sendMessage(message); } } });
        chatForm.addEventListener('submit', function(e) { e.preventDefault(); const message = chatInput.value.trim(); console.log('üîò Submit —Ñ–æ—Ä–º—ã, —Å–æ–æ–±—â–µ–Ω–∏–µ:', message); if (message && !isTyping && !chatInput.disabled) { sendMessage(message); } });

        setTimeout(() => { appendMessage('assistant', '**–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ!** –Ø Zaman AI, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥—Ä—É–≥. ü§ù\n\n–ß—Ç–æ–±—ã —è –º–æ–≥ –¥–∞—Ç—å –≤–∞–º –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç, –Ω–∞—á–Ω–∏—Ç–µ —Å –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É **"üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–∏—Å–∫—É"**.\n\n–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∏–∂–µ üëá', true); console.log('‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–æ'); }, 500);
        console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
    });
    </script>
</body>
</html>